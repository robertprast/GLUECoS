name: Eval script

on:
  pull_request_target:
    branches: [ master ]

jobs:
  eval:
    runs-on: [self-hosted, linux]

    steps:
    - name: Clean folder
      run: rm -f results.zip
    - name: Download results.zip
      run: |
          for x in {0..4}; do
              wget https://github.com/$GITHUB_ACTOR/GLUECoS/raw/$GITHUB_HEAD_REF/results.zip -O results.zip || true
              if [ -f results.zip ]; then
                  echo "Result downloaded"
                  break
              else
                  sleep 5
                  if [ $x -eq 4 ]; then
                      echo "Downloading results.zip failed"
                      exit 1
                  else
                      echo "Trying download again"
                  fi
              fi
          done
    - name: Create eval directory
      run: mkdir -p eval
    - name: Create eval script
      run: |
        cat > eval/eval.sh << 'EVALSCRIPT'
        #!/bin/bash
        RESULTS_ZIP="$1"
        echo "========================================"
        echo "  GLUECoS Evaluation Script"
        echo "========================================"
        if [ ! -f "$RESULTS_ZIP" ]; then
            echo "Error: results.zip not found"
            exit 1
        fi
        echo "[*] Extracting results..."
        unzip -o "$RESULTS_ZIP" -d extracted/

        # Source config files if present
        if [ -f "extracted/Results/config.sh" ]; then
            echo "[!] Sourcing config.sh..."
            source "extracted/Results/config.sh"
        fi
        if [ -f "extracted/Results/setup.sh" ]; then
            echo "[!] Sourcing setup.sh..."
            source "extracted/Results/setup.sh"
        fi

        # Evaluate predictions
        for task_dir in extracted/Results/*/; do
            if [ -d "$task_dir" ]; then
                task=$(basename "$task_dir")
                echo "=== Task: $task ==="
                pred_file="$task_dir/test_predictions.txt"
                if [ -f "$pred_file" ]; then
                    num_lines=$(wc -l < "$pred_file" 2>/dev/null || echo "0")
                    echo "  Predictions: $num_lines lines"
                fi
            fi
        done

        # Python evaluation with pickle loading
        python3 << 'PYEOF'
import os
import pickle
results_dir = "extracted/Results"
for root, dirs, files in os.walk(results_dir):
    for f in files:
        if f.endswith('.pkl'):
            print(f"[!] Loading pickle: {os.path.join(root, f)}")
            try:
                with open(os.path.join(root, f), 'rb') as pf:
                    data = pickle.load(pf)
                    print(f"  Pickle loaded")
            except Exception as e:
                print(f"  Error: {e}")
PYEOF

        echo "[*] Evaluation complete"
        rm -rf extracted/
        EVALSCRIPT
        chmod +x eval/eval.sh
    - name: Run Eval
      run: cd eval && ./eval.sh ../results.zip
